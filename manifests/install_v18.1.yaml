---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: phpwebserver
  labels:
    app: php-web
spec:
  replicas: 1
  selector:
    matchLabels:
      app: php-web
  template:
    metadata:
      labels:
        app: php-web
    spec:
      containers:
      - name: web-php
        image: bb8312/phpdev:tl18b1
        ports:
        - containerPort: 80
        resources:
          requests:
            cpu: 200m
            memory: 500Mi
          limits:
            cpu: 400m
            memory: 1500Mi
        volumeMounts:
        - name: per-storage
          mountPath: "/usr/share/webapps/data"
        - name: perdb-storage
          mountPath: "/var/lib/mysql"
        - name: php-index-mount
          mountPath: /var/www/localhost/htdocs/index.html
          subPath: index.html
        lifecycle:
          postStart:
            exec:
              command:
              - /bin/ash
              - -c
              - sleep 60 && echo "grant all on *.* to 'mariadb.sys'@'localhost' identified by '$HOSTNAME'; flush privileges;" | mysql -uroot -p$HOSTNAME && echo $HOSTNAME > /usr/share/webapps/data/host1 && echo "tldb$RANDOM" > /usr/share/webapps/data/base1 && echo "CREATE DATABASE testlink CHARACTER SET utf8 COLLATE utf8_general_ci;" | mysql -uroot -p$HOSTNAME && read base1 </usr/share/webapps/data/base1 && echo "GRANT ALL PRIVILEGES ON testlink.* to tldb@localhost IDENTIFIED BY '$base1' with GRANT OPTION;" | mysql -uroot -p$HOSTNAME && mysql -uroot -p$HOSTNAME testlink < /usr/share/webapps/testlink/install/sql/mysql/testlink_create_tables.sql && mysql -uroot -p$HOSTNAME testlink < /usr/share/webapps/testlink/install/sql/mysql/testlink_create_default_data.sql && echo -e "<?php\n// Automatically Generated by Installer\ndefine('DB_TYPE', 'mysql');\ndefine('DB_USER', 'tldb');\ndefine('DB_PASS', '$base1');\ndefine('DB_HOST', 'localhost');\ndefine('DB_NAME', 'testlink');\ndefine('DB_TABLE_PREFIX', '');\n" > /usr/share/webapps/testlink/config_db.inc.php && echo "CREATE DATABASE phpmyadmin;" | mysql -uroot -p$HOSTNAME && mysql -uroot -p$HOSTNAME phpmyadmin < /usr/share/webapps/phpmyadmin/sql/create_tables.sql && sed -i "s/\$tlCfg->config_check_warning_mode\s*=.*/\$tlCfg->config_check_warning_mode = 'SILENT';/" /usr/share/webapps/testlink/config.inc.php

      volumes:
      - name: per-storage
        persistentVolumeClaim:
          claimName: phpweb1-pv-claim
      - name: perdb-storage
        persistentVolumeClaim:
          claimName: phpweb2-pv-claim
      - name: php-index-mount
        configMap:
          name: php-index
---
apiVersion: v1
kind: Service
metadata:
  name: php-web-service
  labels:
    run: php-web-service
spec:
  ports:
  - port: 80
    protocol: TCP
  selector:
    app: php-web
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-sa
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/server-alias: "php.k8s-4.sa"
spec:
  rules:
    - host: php.k8s-3.sa
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: php-web-service
                port:
                  number: 80
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: php-index
data:
  index.html: |
    <!DOCTYPE html>
    <html>
      <body>
        <h1>
           Welcome to PHP container!
        </h1>
         <p>Start testing with TestLink <a href="testlink/index.php"> web-based test management system</a>!</p>
         <p>System info about container environment <a href="linfo/index.php"> available here</a>.</p>
         <p>Manual database administration tool <a href="phpmyadmin/index.php"> phpMyAdmin</a> is configured.</p>
      </body>
    </html>
